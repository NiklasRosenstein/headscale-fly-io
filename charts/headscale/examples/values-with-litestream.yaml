# Example values for deploying Headscale with Litestream backup
# This configuration matches the Fly.io deployment with Tigris/S3 backup

headscale:
  domainName: "vpn.example.com"

  dns:
    baseDomain: "tailnet"
    magicDns: true

# Persistence for local SQLite storage
persistence:
  enabled: true
  size: 1Gi

# Enable Litestream for SQLite replication to S3
litestream:
  enabled: true

  s3:
    # S3-compatible storage bucket
    bucket: "my-headscale-backup"
    # S3 endpoint (use your provider's endpoint)
    # AWS S3: https://s3.{region}.amazonaws.com
    # MinIO: https://minio.example.com
    # Tigris: https://fly.storage.tigris.dev
    # Cloudflare R2: https://{account_id}.r2.cloudflarestorage.com
    endpoint: "https://s3.us-east-1.amazonaws.com"
    region: "us-east-1"
    # Path prefix in the bucket
    path: "headscale.db"

  # AWS credentials
  # For production, use existingSecret instead
  aws:
    # Option 1: Inline credentials (not recommended for production)
    # accessKeyId: "AKIAIOSFODNN7EXAMPLE"
    # secretAccessKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"

    # Option 2: Use existing Kubernetes secret (recommended)
    existingSecret: "headscale-s3-credentials"
    accessKeyIdKey: "aws-access-key-id"
    secretAccessKeyKey: "aws-secret-access-key"

  # Optional: AGE encryption key for backup encryption
  # Generate with: age-keygen
  # ageSecretKey: "AGE-SECRET-KEY-..."

  # Litestream tuning (defaults match Fly.io configuration)
  retention: "24h"
  syncInterval: "1s"
  retentionCheckInterval: "1h"
  validationInterval: "12h"

# Use existing secret for Headscale credentials
# Create with:
# kubectl create secret generic headscale-secrets \
#   --from-literal=noise-private-key="privkey:$(openssl rand -hex 32)" \
#   --from-literal=age-secret-key="$(age-keygen 2>&1 | tail -n1)"
existingSecret: "headscale-secrets"

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: vpn.example.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: headscale-tls
      hosts:
        - vpn.example.com

# ---
# Create the required secrets before deploying:
#
# # Generate and create Headscale secrets
# NOISE_KEY="privkey:$(openssl rand -hex 32)"
# AGE_KEY="$(age-keygen 2>&1 | tail -n1)"
#
# kubectl create secret generic headscale-secrets \
#   --namespace headscale \
#   --from-literal=noise-private-key="$NOISE_KEY" \
#   --from-literal=age-secret-key="$AGE_KEY"
#
# # Create S3 credentials secret
# kubectl create secret generic headscale-s3-credentials \
#   --namespace headscale \
#   --from-literal=aws-access-key-id="YOUR_ACCESS_KEY" \
#   --from-literal=aws-secret-access-key="YOUR_SECRET_KEY"
